# This workload is developed to test the amount of time it takes to update a million documents in
# a single replica set transaction. At the moment, the average time taken raises above the default
# limit, so until we add a way to manually increase a transaction's lifetime, we must raise the
# lifetime of all transactions.

SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  The parameters for materialized views experiments.

Clients:
  Default:
    QueryOptions:
      minPoolSize: 1
      maxPoolSize: 10000

ExperimentParams: &ExprParams
  Transactional: &isTransactional {^Parameter: {Default: true, Name: "Transactional"}}
  NumInitialDocs: &numInitialDocs {^Parameter: {Default: 100000, Name: "NumInitialDocs"}}
  BaseDocumentSizePaddingBytes: &baseDocumentSizePaddingBytes {^Parameter: {Default: 1000, Name: "BaseDocumentSizePaddingBytes"}}
  NumGroupsAndDistribution: &numGroupsAndDistribution {^Parameter: {Default: {^RandomInt: {distribution: uniform, min: 0, max: 10}}, Name: "NumGroupsAndDistribution"}}
  ClientThreads: &clientThreads {^Parameter: {Default: 100, Name: "ClientThreads"}}
  NumInsertBatchesPerClinet: &numInsertBatchesPerClinet {^Parameter: {Default: 10, Name: "NumInsertBatchesPerClinet"}}
  NumInsertOpsPerClinetBatch: &numInsertOpsPerClinetBatch {^Parameter: {Default: 10, Name: "NumInsertOpsPerClinetBatch"}}
  ClientBatchInsertMode: &clientBatchInsertMode {^Parameter: {Default: "insertMany", Name: "ClientBatchInsertMode"}}
  NumMatViews: &numMatViews {^Parameter: {Default: 0, Name: "NumMatViews"}}
  MatViewMaintenanceMode: &matViewMaintenanceMode {^Parameter: {Default: "wild-card-index", Name: "MatViewMaintenanceMode"}}

MatViewParamsGenericDefaults:
  PhasePath: &PhasePath ./MatViewParamsGeneric.yml
  DbName: &db test
  Collection: &col Collection0 # This is the default collection populated by the Loader.
  FullName: &fullname test.Collection0
  Nop: &Nop {Nop: true}

ActorsConf:
- Name: LoaderActor
  Type: Loader
  Threads: 1
  Phases:
  - LoadConfig:
      Path: *PhasePath
      Key: LoaderPhase
      Parameters: *ExprParams
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
- Name: IndexCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: *db
    Operations:
    - OperationMetricsName: CreateWildCardIndexesCmd
      OperationName: RunCommand
      OperationCommand:
        createIndexes: *col
        indexes:
        - key: { "$**": 1 }
          name: wildCardIndex
  - *Nop
  - *Nop
  - *Nop
  - *Nop
- Name: EnableSharding
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: *db
  - *Nop
  - *Nop
  - *Nop
  - *Nop
- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: *fullname  # Collection0 is the default collection populated by the Loader.
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_CODelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_NCDelta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_NCDelta
        key:
          _id: hashed
  - *Nop
  - *Nop
  - *Nop
- Name: InitialBuildViewActor
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *PhasePath
      Key: InitialBuildViewPhase
      Parameters: *ExprParams
  - *Nop
  - *Nop
- Name: UpdateDocumentsInTransactionActor
  Type: CrudActor
  Database: *db
  Threads: *clientThreads
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *PhasePath
      Key: BaseCollInsertAndMatViewPhase
      Parameters: *ExprParams
  - *Nop
- Name: CleanupActor
  Type: RunCommand
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *PhasePath
      Key: BaseCollDeletePhase
      Parameters: *ExprParams

# This workload is developed to test the amount of time it takes to update a million documents in
# a single replica set transaction. At the moment, the average time taken raises above the default
# limit, so until we add a way to manually increase a transaction's lifetime, we must raise the
# lifetime of all transactions.

SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  The parameters for materialized views experiments.

ExperimentParameters: &ExprParams
  ClientThreads: &clientThreads {^Parameter: {Default: 100, Name: "ClientThreads"}}

MatViewParamsGenericDefaults:
  PhasePath: &PhasePath ./MatViewParamsGeneric.yml
  DbName: &db test
  Collection: &col Collection0 # This is the default collection populated by the Loader.
  FullName: &fullname test.Collection0
  Nop: &Nop {Nop: true}

ActorsConf:
- Name: LoaderActor
  Type: Loader
  Threads: 1
  Phases:
  - LoadConfig:
      Path: *PhasePath
      Key: LoaderPhase
      Parameters: *ExprParams
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
- Name: EnableSharding
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: *db
  - *Nop
  - *Nop
  - *Nop
  - *Nop
- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: *fullname  # Collection0 is the default collection populated by the Loader.
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_uniform_1_1_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_uniform_1_10_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_uniform_1_100_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_uniform_1_1000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_uniform_1_10000_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_binomial_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView0_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView1_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView2_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView3_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView4_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView5_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView6_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView7_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView8_geometric_Delta
        key:
          _id: hashed
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0MatView9_geometric_Delta
        key:
          _id: hashed
  - *Nop
  - *Nop
  - *Nop
- Name: InitialBuildViewActor
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *PhasePath
      Key: InitialBuildViewPhase
      Parameters: *ExprParams
  - *Nop
  - *Nop
- Name: UpdateDocumentsInTransactionActor
  Type: MatViewActor
  Database: *db
  Threads: *clientThreads
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *PhasePath
      Key: BaseCollInsertAndMatViewPhase
      Parameters: *ExprParams
  - *Nop
- Name: CleanupActor
  Type: RunCommand
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: *PhasePath
      Key: BaseCollDeletePhase
      Parameters: *ExprParams

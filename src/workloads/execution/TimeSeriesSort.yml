SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This test exercises the behavior of $_internalBoundedSort TODO expand on this

GlobalDefaults:
  dbname: &db test
  batchSize: &batchSize 30000
  fieldName: &field "numeric"
  index: &index
    keys: {numeric: 1}
  nop: &Nop {Nop: true}

Actors:
- Name: CreateTimeSeriesCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: *db
    Operation:
      OperationMetricsName: CreateTimeSeriesCollection
      OperationName: RunCommand
      OperationCommand:
        {create: &coll Collection0, timeseries: {timeField: "t", metaField: "m"}}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - Repeat: 1
    Database: *db
    Collection: *coll
    Threads: 1
    CollectionCount: 1
    # To get a good signal we need this to be at least bucket size squared.
    # The bucket size is 360. This is 360 * 360 *8. The 8 is just for safety.
    DocumentCount: 103680 # TODO fix this
    BatchSize: *batchSize
    Document:
      t: {^IncDate: {start: "2022-01-01", step: 40000}}
      m: {^RandomString: {length: 4}}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: Queries
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  # - Repeat: 1
  #   Database: *db
  #   Operations:
  #   - OperationMetricsName: CreateIndex
  #     OperationName: RunCommand
  #     OperationCommand:
  #       createIndexes: Collection0
  #       indexes:
  #       - key:
  #           t: 1
  #         name: timeAsc
  - *Nop
  # - Repeat: 1
  #   Database: *db
  #   Operations:
  #   - OperationMetricsName: SortQuery
  #     OperationName: RunCommand
  #     OperationCommand:
  #       aggregate: Collection0
  #       pipeline: [{$sort: {t: 1}}]
  #       cursor: {batchSize: *batchSize}
  - Repeat: 50
    Database: *db
    Operations:
    - OperationMetricsName: SortQueryNoBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{$sort: {"t": 1}}]
        cursor: {batchSize: *batchSize}
  - Repeat: 50
    Database: *db
    Operations:
    - OperationMetricsName: SortQueryBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: system.buckets.Collection0
        pipeline: [{$sort: {"control.min.t": 1}},
                    {$_internalUnpackBucket: {
                      exclude : [ ],
                      timeField : "t",
                      metaField : "m",
                      bucketMaxSpanSeconds : 3600,
                      assumeNoMixedSchemaData : true
                      }
                    },
                    {$_internalBoundedSort: {
                            sortKey: {t: 1},
                            bound: 3600,
                        }
                    }]
        cursor: {batchSize: *batchSize}
  # - Repeat: 1
  #   Database: *db
  #   Operations:
  #   - OperationMetricsName: DropIndex
  #     OperationName: RunCommand
  #     OperationCommand:
  #       dropIndexes: Collection0
  #       index: timeAsc
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - replica
      - replica-all-feature-flags
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1
      - v5.2

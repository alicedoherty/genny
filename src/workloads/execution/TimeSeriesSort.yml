SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This test exercises the behavior of $_internalBoundedSort TODO expand on this

GlobalDefaults:
  dbname: &db test
  batchSize: &batchSize 30000
  fieldName: &field "numeric"
  index: &index
    keys: {numeric: 1}
  nop: &Nop {Nop: true}

Actors:
- Name: CreateTimeSeriesCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop # 0
  - Repeat: 1 # 1
    Database: *db
    Operation:
      OperationMetricsName: CreateTimeSeriesCollection
      OperationName: RunCommand
      OperationCommand:
        {create: &coll Collection0, timeseries: {timeField: "t", metaField: "m"}}
  - *Nop # 2
  - *Nop # 3
  - *Nop # 4
  - *Nop # 5
  - *Nop # 6
  - *Nop # 7
  - *Nop # 8
  - *Nop # 9
  - *Nop # 10
  - *Nop # 11
  - *Nop # 12
  - *Nop # 13
  - *Nop # 13.1
  - *Nop # 13.2
  - *Nop # 13.3
  - *Nop # 14
  - *Nop # 15
  - *Nop # 16
  - *Nop # 17
  - *Nop # 18
  - *Nop # 19
  - *Nop # 20
  - *Nop # 21

- Name: IndexCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop # 0
  - *Nop # 1
  - *Nop # 2
  - *Nop # 3
  - *Nop # 4
  - *Nop # 5
  - *Nop # 6
  - *Nop # 7
  - *Nop # 8
  - *Nop # 9
  - *Nop # 10
  # - *Nop # 11
  - Repeat: 1 # 11
    Database: *db
    Operations:
    - OperationMetricsName: CreateMetaTimeIndex
      OperationName: RunCommand
      OperationCommand:
        createIndexes: *coll
        indexes:
        - key: {m: 1, t: 1}
          name: MetaTime
  - *Nop # 12
  - *Nop # 13
  - *Nop # 13.1
  - *Nop # 13.2
  - *Nop # 13.3
  - *Nop # 14
  # - Repeat: 1 # 14
  #   Database: *db
  #   Operations:
  #   - OperationMetricsName: DropMetaTimeIndex
  #     OperationName: RunCommand
  #     OperationCommand:
  #       dropIndexes: *coll
  #       index: MetaTime
  - *Nop # 15
  - *Nop # 16
  - *Nop # 17
  - *Nop # 18
  - *Nop # 19
  - *Nop # 20
  - *Nop # 21


- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - *Nop # 0
  - Repeat: 1 # 1
  - *Nop # 2
  - Repeat: 1 # 3
  - *Nop # 4
  - Repeat: 1 # 5
  - *Nop # 6
  - Repeat: 1 # 7
  - *Nop # 8
  - Repeat: 1 # 9
  - *Nop # 10
  - Repeat: 1 # 11
  - *Nop # 12
  - Repeat: 1 # 13
  - *Nop # 13.1
  - Repeat: 1 # 13.2
  - *Nop # 13.3
  - Repeat: 1 # 14
  - *Nop # 15
  - Repeat: 1 # 16
  - *Nop # 17
  - Repeat: 1 # 18
  - *Nop # 19
  - Repeat: 1 # 20
  - *Nop # 21

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - *Nop # 0
  - *Nop # 1
  - *Nop # 2
  - Repeat: 1 # 3
    Database: *db
    Collection: *coll
    Threads: 1
    CollectionCount: 1
    DocumentCount: 103680
    BatchSize: *batchSize
    Document:
      t: {^IncDate: {start: "2022-01-01", step: 400}}
      m: {^RandomInt: {min: 0, max: 1000}}
  - *Nop # 4
  - *Nop # 5
  - *Nop # 6
  - *Nop # 7
  - *Nop # 8
  - *Nop # 9
  - *Nop # 10
  - *Nop # 11
  - *Nop # 12
  - *Nop # 13
  - Repeat: 1 # 13.1
    Database: *db
    Collection: *coll
    Threads: 1
    CollectionCount: 1
    DocumentCount: 10
    BatchSize: *batchSize
    Document:
      t: {^IncDate: {start: "2024-01-01", step: 400}}
      m: 1001
  - *Nop # 13.2
  - *Nop # 13.3
  # - *Nop # 14
  - Repeat: 1 # 14
    Database: *db
    Collection: *coll
    Threads: 1
    CollectionCount: 1
    DocumentCount: 503680
    BatchSize: *batchSize
    Document:
      t: {^IncDate: {start: "2023-01-01", step: 400}}
      m: {^RandomInt: {min: 0, max: 1000}}
  - *Nop # 15
  - *Nop # 16
  - *Nop # 17
  - *Nop # 18
  - *Nop # 19
  - *Nop # 20
  - *Nop # 21

- Name: Queries
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop # 0
  - *Nop # 1
  - *Nop # 2
  - *Nop # 3
  - *Nop # 4
  - *Nop # 5
  - *Nop # 6
  - Repeat: &numQueryRuns 50 # 7
    Database: *db
    Operations:
    - OperationMetricsName: SortQueryNoBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline: [{$sort: {"t": 1}}]
        cursor: {batchSize: *batchSize}
  - Repeat: *numQueryRuns # 8
    Database: *db
    Operations:
    - OperationMetricsName: SortQueryBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: system.buckets.Collection0
        pipeline: [{$sort: {"control.min.t": 1}},
                    {$_internalUnpackBucket: {
                      exclude : [ ],
                      timeField : "t",
                      metaField : "m",
                      bucketMaxSpanSeconds : 3600,
                      assumeNoMixedSchemaData : true
                      }
                    },
                    {$_internalBoundedSort: {
                            sortKey: {t: 1},
                            bound: 3600,
                        }
                    }]
        cursor: {batchSize: *batchSize}
  - Repeat: *numQueryRuns # 9
    Database: *db
    Operations:
    - OperationMetricsName: TimeToFirstResultQueryNoBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline: [{$sort: {"t": 1}}, {$_internalInhibitOptimization: {}}, {$limit: 1}]
        cursor: {batchSize: *batchSize}
  - Repeat: *numQueryRuns # 10
    Database: *db
    Operations:
    - OperationMetricsName: TimeToFirstResultQueryBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: system.buckets.Collection0
        pipeline: [{$sort: {"control.min.t": 1}},
                    {$_internalUnpackBucket: {
                      exclude : [ ],
                      timeField : "t",
                      metaField : "m",
                      bucketMaxSpanSeconds : 3600,
                      assumeNoMixedSchemaData : true
                      }
                    },
                    {$_internalBoundedSort: {
                            sortKey: {t: 1},
                            bound: 3600,
                        }
                    },
                    {$limit: 1}]
        cursor: {batchSize: *batchSize}
  - *Nop # 11
  - Repeat: *numQueryRuns # 12
    Database: *db
    Operations:
    - OperationMetricsName: MetaPointPredicateTimeSortNoBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline: [{$match: {m: 1}}, {$sort: {t: 1}}] # this will match ~100 docs
        cursor: {batchSize: *batchSize}
  - Repeat: *numQueryRuns # 13
    Database: *db
    Operations:
    - OperationMetricsName: MetaPointPredicateTimeSortBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: system.buckets.Collection0
        pipeline: [{$match: {meta: 1}},
                    {$sort: {"control.min.t": 1}},
                    {$_internalUnpackBucket: {
                      exclude : [ ],
                      timeField : "t",
                      metaField : "m",
                      bucketMaxSpanSeconds : 3600,
                      assumeNoMixedSchemaData : true
                      }
                    },
                    {$_internalBoundedSort: {
                            sortKey: {t: 1},
                            bound: 3600,
                        }
                    }]
        cursor: {batchSize: *batchSize}
  - *Nop # 13.1
  - Repeat: *numQueryRuns # 13.2
    Database: *db
    Operations:
    - OperationMetricsName: SelectiveMetaPointPredicateTimeSortNoBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline: [{$match: {m: 1001}}, {$sort: {t: 1}}] # this will match ~100 docs
        cursor: {batchSize: *batchSize}
  - Repeat: *numQueryRuns # 13.3
    Database: *db
    Operations:
    - OperationMetricsName: SelectiveMetaPointPredicateTimeSortBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: system.buckets.Collection0
        pipeline: [{$match: {meta: 1001}},
                    {$sort: {"control.min.t": 1}},
                    {$_internalUnpackBucket: {
                      exclude : [ ],
                      timeField : "t",
                      metaField : "m",
                      bucketMaxSpanSeconds : 3600,
                      assumeNoMixedSchemaData : true
                      }
                    },
                    {$_internalBoundedSort: {
                            sortKey: {t: 1},
                            bound: 3600,
                        }
                    }]
        cursor: {batchSize: *batchSize}
  - *Nop # 14
  - *Nop # 15
  - *Nop # 16
  - Repeat: *numQueryRuns # 17
    Database: *db
    Operations:
    - OperationMetricsName: SpillVsNoSpillSortQueryNoBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline: [{$sort: {"t": 1}}]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
  - Repeat: *numQueryRuns # 18
    Database: *db
    Operations:
    - OperationMetricsName: SpillVsNoSpillSortQueryBoundedSorter
      OperationName: RunCommand
      OperationCommand:
        aggregate: system.buckets.Collection0
        pipeline: [{$sort: {"control.min.t": 1}},
                    {$_internalUnpackBucket: {
                      exclude : [ ],
                      timeField : "t",
                      metaField : "m",
                      bucketMaxSpanSeconds : 3600,
                      assumeNoMixedSchemaData : true
                      }
                    },
                    {$_internalBoundedSort: {
                            sortKey: {t: 1},
                            bound: 3600,
                        }
                    }]
        cursor: {batchSize: *batchSize}
  - *Nop # 19
  - *Nop # 20
  - *Nop # 21

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - replica
      - replica-all-feature-flags
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1
      - v5.2

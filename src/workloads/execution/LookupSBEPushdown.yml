SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  This workload measures $lookup performance for scenarios that look up local integer key against
  foreign collection's integer key, when the foreign collections have multiple collection
  cardinalities such as 1500 / 3500 / 5500 / 7500 / 9500.

  While measuring performances, this workload collects numbers for either the SBE or the classic
  engine $lookup implementations, depending on environments that it runs on. The SBE $lookup
  implements the hash join and the (index) nested loop join but the classic $lookup implements
  only (index) nested loop join. So we can compare the SBE HJ / NLJ implementations to the classic
  engine NLJ implementation and the SBE INLJ implementation to the classic engine INLJ
  implementation.

  Numbers on the 'standalone-all-feature-flags' environment are for the SBE $lookup and numbers on
  the 'standalone' environment for the classic $lookup until the SBE $lookup pushdown feature will
  be turned on by default.

  Naming convention for collection names:
  Foreign_[DocumentSize]_[NoOfDocs]docs_[KeyGenerationMethod][NoOfUniqueKeys]g
  - DocumentSize: SmallDoc / LocalLargeDoc
  - NoOfDocs: 'k' means 1000 and 'docs' means documents
  - KeyGenerationMethod:
    . Inc: Monotonically increasing key values
    . Rand: Randomly generated key values
  - NoOfUniqueKeys: 'g' means groups

  Name convention for OperationMetricsName:
  [LocalCollectionName]_[LocalJoinFieldType]_[ForeignCollectionName]_[ForeignJoinFieldType]

  In summary, this workload conducts testing for the following test matrix:
  - JoinType: HJ / NLJ / INLJ
  - ForeignCollectionCardinality: 1500 / 3500 / 5500 / 7500 / 9500
  - The local collection has 100k documents and its documents are small ones

  The workload consists of the following phases and actors:
    0. Cleans up database
       - 'Setup' actor
    1. Loads data into the local and foreign collections
       - 'LoadXXX' actors
    2. Calms down to isolate any trailing impacts from the load phase
       - 'Quiesce' actor
    3. Runs and measures either the SBE HJ lookups or the classic NLJ lookups, depending on the
       environment
       - 'HJLookup' actor
    4. Runs and measures either the SBE NLJ lookups or the classic NLJ lookups, depending on the
       environment
       - 'NLJLookup' actor
    5. Builds indexes on foreign collections
       - 'BuildIndexes' actor
    6. Calms down to isolate any trailing impacts from the previous phase
       - 'Quiesce' actor
    7. Runs and measures the SBE INLJ lookups and the classic INLJ lookups
       - 'INLJLookup' actor

Keywords:
- lookup
- aggregate
- sbe

# Defines the database name.
Database: &db lookup_sbe_pushdown

# Defines foreign collection names.
Foreign_SmallDoc_1500docs_Inc1500g: &Foreign_SmallDoc_1500docs_Inc1500g foreign_smalldoc_1500docs_inc1500g
Foreign_SmallDoc_3500docs_Inc3500g: &Foreign_SmallDoc_3500docs_Inc3500g foreign_smalldoc_3500docs_inc3500g
Foreign_SmallDoc_5500docs_Inc5500g: &Foreign_SmallDoc_5500docs_Inc5500g foreign_smalldoc_5500docs_inc5500g
Foreign_SmallDoc_7500docs_Inc7500g: &Foreign_SmallDoc_7500docs_Inc7500g foreign_smalldoc_7500docs_inc7500g
Foreign_SmallDoc_9500docs_Inc9500g: &Foreign_SmallDoc_9500docs_Inc9500g foreign_smalldoc_9500docs_inc9500g

# Defines the local collection name.
Local_SmallDoc_100kdocs_Rand1500g: &Local_SmallDoc_100kdocs_Rand1500g local_smalldoc_100kdocs_rand1500g
Local_SmallDoc_100kdocs_Rand3500g: &Local_SmallDoc_100kdocs_Rand3500g local_smalldoc_100kdocs_rand3500g
Local_SmallDoc_100kdocs_Rand5500g: &Local_SmallDoc_100kdocs_Rand5500g local_smalldoc_100kdocs_rand5500g
Local_SmallDoc_100kdocs_Rand7500g: &Local_SmallDoc_100kdocs_Rand7500g local_smalldoc_100kdocs_rand7500g
Local_SmallDoc_100kdocs_Rand9500g: &Local_SmallDoc_100kdocs_Rand9500g local_smalldoc_100kdocs_rand9500g

# Defines the local collection document generators which are used by 'LoadLocalXXX' actors. See
# 'LocalSmallDocRandKeyTemplate' to understand how each doc is filled.
Local_SmallDoc_Rand1500g: &Local_SmallDoc_Rand1500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 1500

Local_SmallDoc_Rand3500g: &Local_SmallDoc_Rand3500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 3500

Local_SmallDoc_Rand5500g: &Local_SmallDoc_Rand5500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 5500

Local_SmallDoc_Rand7500g: &Local_SmallDoc_Rand7500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 7500

Local_SmallDoc_Rand9500g: &Local_SmallDoc_Rand9500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 9500

# Defines foreign collection document generators which are used by 'LoadForeignXXX' actor. See
# 'ForeignSmallDocIncKeyTemplate' to understand how each doc is filled.
Foreign_SmallDoc_Inc1500g: &Foreign_SmallDoc_Inc1500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 1500

Foreign_SmallDoc_Inc3500g: &Foreign_SmallDoc_Inc3500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 3500

Foreign_SmallDoc_Inc5500g: &Foreign_SmallDoc_Inc5500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 5500

Foreign_SmallDoc_Inc7500g: &Foreign_SmallDoc_Inc7500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 7500

Foreign_SmallDoc_Inc9500g: &Foreign_SmallDoc_Inc9500g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 9500

# Defines HJ lookup commands which are used by 'HJLookup' actor. See 'HJLookupCmdTemplate' for
# details. To enable the SBE HJ lookup, the template has 'allowDiskUse: true' argument and all
# foreign collections has the cardinality < 10000 and 'HJLookup' actor runs before creating any
# indexes on any join fields.
HJLookupForeign1500Cmd: &HJLookupForeign1500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand1500g
      f: *Foreign_SmallDoc_1500docs_Inc1500g

HJLookupForeign3500Cmd: &HJLookupForeign3500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand3500g
      f: *Foreign_SmallDoc_3500docs_Inc3500g

HJLookupForeign5500Cmd: &HJLookupForeign5500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand5500g
      f: *Foreign_SmallDoc_5500docs_Inc5500g

HJLookupForeign7500Cmd: &HJLookupForeign7500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand7500g
      f: *Foreign_SmallDoc_7500docs_Inc7500g

HJLookupForeign9500Cmd: &HJLookupForeign9500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand9500g
      f: *Foreign_SmallDoc_9500docs_Inc9500g

# Defines NLJ lookup commands which are used by 'NLJLookup' / 'INLJLookup' actors. See
# 'NLJLookupCmdTemplate' for details. The command template can be used for INLJ too because INLJ
# will be enabled when the foreign join field is indexed.
NLJLookupForeign1500Cmd: &NLJLookupForeign1500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand1500g
      f: *Foreign_SmallDoc_1500docs_Inc1500g

NLJLookupForeign3500Cmd: &NLJLookupForeign3500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand3500g
      f: *Foreign_SmallDoc_3500docs_Inc3500g

NLJLookupForeign5500Cmd: &NLJLookupForeign5500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand5500g
      f: *Foreign_SmallDoc_5500docs_Inc5500g

NLJLookupForeign7500Cmd: &NLJLookupForeign7500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand7500g
      f: *Foreign_SmallDoc_7500docs_Inc7500g

NLJLookupForeign9500Cmd: &NLJLookupForeign9500Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_100kdocs_Rand9500g
      f: *Foreign_SmallDoc_9500docs_Inc9500g

# Defines test operations for 'HJLookup' actor.
HJTestOperations: &HJTestOperations
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand1500g_IntTopField_Foreign_SmallDoc_1500docs_Inc1500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupForeign1500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand3500g_IntTopField_Foreign_SmallDoc_3500docs_Inc3500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupForeign3500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand5500g_IntTopField_Foreign_SmallDoc_5500docs_Inc5500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupForeign5500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand7500g_IntTopField_Foreign_SmallDoc_7500docs_Inc7500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupForeign7500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand9500g_IntTopField_Foreign_SmallDoc_9500docs_Inc9500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupForeign9500Cmd

# Defines test operations for 'NLJLookup'/ 'INLJLookup' actors.
NLJTestOperations: &NLJTestOperations
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand1500g_IntTopField_Foreign_SmallDoc_1500docs_Inc1500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign1500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand3500g_IntTopField_Foreign_SmallDoc_3500docs_Inc3500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign3500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand5500g_IntTopField_Foreign_SmallDoc_5500docs_Inc5500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign5500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand7500g_IntTopField_Foreign_SmallDoc_7500docs_Inc7500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign7500Cmd
- OperationMetricsName: Local_SmallDoc_100kdocs_Rand9500g_IntTopField_Foreign_SmallDoc_9500docs_Inc9500g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign9500Cmd

# Defines how many times each test operation is executed.
TestRepeatCount: &TestRepeatCount 10

Actors:
# The 'Setup' actor drops the database and runs in the 0th phase.
- Name: Setup
  Type: RunCommand
  Database: *db
  Thread: 1
  Phases:
  - Repeat: 1
    Threads: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand: {dropDatabase: 1}
  - Phase: 1..7
    Nop: true

# The 'LoadForeignXXX' / 'LoadLocalXXX' actors run in the 1st phase.
- Name: LoadForeign_SmallDoc_1500docs_Inc1500g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - &Nop {Nop: true}
  - Repeat: 1500
    Threads: 1
    Collection: *Foreign_SmallDoc_1500docs_Inc1500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc1500g
  - Phase: 2..7
    Nop: true

- Name: LoadForeign_SmallDoc_3500docs_Inc3500g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 3500
    Threads: 1
    Collection: *Foreign_SmallDoc_3500docs_Inc3500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc3500g
  - Phase: 2..7
    Nop: true

- Name: LoadForeign_SmallDoc_5500docs_Inc5500g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 5500
    Threads: 1
    Collection: *Foreign_SmallDoc_5500docs_Inc5500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc5500g
  - Phase: 2..7
    Nop: true

- Name: LoadForeign_SmallDoc_7500docs_Inc7500g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 7500
    Threads: 1
    Collection: *Foreign_SmallDoc_7500docs_Inc7500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc7500g
  - Phase: 2..7
    Nop: true

- Name: LoadForeign_SmallDoc_9500docs_Inc9500g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 9500
    Threads: 1
    Collection: *Foreign_SmallDoc_9500docs_Inc9500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc9500g
  - Phase: 2..7
    Nop: true

- Name: LoadLocal_SmallDoc_100kdocs_Rand1500g
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 10000
    Threads: 1
    Collection: *Local_SmallDoc_100kdocs_Rand1500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand1500g
  - Phase: 2..7
    Nop: true

- Name: LoadLocal_SmallDoc_100kdocs_Rand3500g
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 10000
    Threads: 1
    Collection: *Local_SmallDoc_100kdocs_Rand3500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand3500g
  - Phase: 2..7
    Nop: true

- Name: LoadLocal_SmallDoc_100kdocs_Rand5500g
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 10000
    Threads: 1
    Collection: *Local_SmallDoc_100kdocs_Rand5500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand5500g
  - Phase: 2..7
    Nop: true

- Name: LoadLocal_SmallDoc_100kdocs_Rand7500g
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 10000
    Threads: 1
    Collection: *Local_SmallDoc_100kdocs_Rand7500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand7500g
  - Phase: 2..7
    Nop: true

- Name: LoadLocal_SmallDoc_100kdocs_Rand9500g
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 10000
    Threads: 1
    Collection: *Local_SmallDoc_100kdocs_Rand9500g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand9500g
  - Phase: 2..7
    Nop: true

# The 'Quiesce' actor calms down to avoid any trailing impacts from the previous phase and runs
# in the 2nd and 6th phases.
- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
  - Phase: 3..5
    Nop: true
  - Repeat: 1
  - *Nop

# The 'HJLookup' actor measures the SBE HJ lookup performances on an all-feature-flags build and
# runs in the 3rd phase. HJLookup becomes a NLJLookup on a normal build.
- Name: HJLookup
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..2
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *HJTestOperations
  - Phase: 4..7
    Nop: true

# The 'NLJLookup' actor measures the NLJ lookup performances and runs in the 4th phase.
- Name: NLJLookup
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..3
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *NLJTestOperations
  - Phase: 5..7
    Nop: true

# The 'BuildIndexes' actor builds indexes on 'int_key' / 'str_key' join fields of foreign
# collections so that INLJ lookup performances can be measured and runs in the 5th phase.
- Name: BuildIndexes
  Type: RunCommand
  Phases:
  - Phase: 0..4
    Nop: true
  - Repeat: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_1500docs_Inc1500g
        indexes: &IndexSpec [{key: {"int_key": 1}, name: "idx"}, {key: {str_key: 1}, name: "str_idx"}]
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_3500docs_Inc3500g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_5500docs_Inc5500g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_7500docs_Inc7500g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_9500docs_Inc9500g
        indexes: *IndexSpec
  - *Nop
  - *Nop

# The 'INLJLookup' actor measures the INLJ lookup performances and runs in the 7th phase.
- Name: INLJLookup
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..6
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *NLJTestOperations

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-all-feature-flags

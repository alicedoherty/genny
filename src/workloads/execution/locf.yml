SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload tests the performance of $locf. The benchmark operations test numeric,
  string, date and randomized data types. There is a test without partitions, with a 
  single partition, and with multiple partitions for each data type.

Actors:
- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - Repeat: 1
    Database: &db test
    Threads: 1
    CollectionCount: 1
    DocumentCount: 10000
    BatchSize: &batchSize 100
    Document:
      part1: {^Choose: {from: [1, 2, 3, 4]}}
      part2: {^Choose: {from: [1, 2, 3, 4]}}
      numeric: {^Choose: {from: [
        {^RandomInt: {min: -100, max: 100}}, 
        {^RandomDouble: { min: 0.0, max: 500.0 }},
        null], weights: [1, 1, 8]}}
      string: {^Choose: {from: [
        {^RandomString: {length: 15}}, 
        null], weights: [2,8]}}
      date: {^Choose: {from: [
        {^RandomDate: {min: "2021-01-01", max: "2023-01-01"}}, 
        null], weights: [2, 8]}}
      randomType: {^Choose: {from: [
        {^RandomInt: {min: -100, max: 100}}, 
        {^RandomDouble: { min: 0.0, max: 500.0 }}, 
        {^RandomDate: {min: "2021-01-01", max: "2023-01-01"}}, 
        {^RandomString: {length: 15}}, 
        null], weights: [1, 1, 1, 1, 5]}}
  - Nop: true
  - Nop: true

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - Nop: true
  - Repeat: 1
  - Nop: true

- Name: Locf
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true
  - Nop: true
  - Repeat: 10
    Database: *db
    Operations:
    - OperationMetricsName: TestNumericWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
                numeric: {
                  $locf: "$numeric"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: TestDateWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
                date: {
                  $locf: "$date"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: TestStringWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
                string: {
                  $locf: "$string"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: TestRandomTypeWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
                randomType: {
                  $locf: "$randomType"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: TestMultipleOutputWithoutPartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            output: {
                numeric: {
                  $locf: "$numeric"},
                string: {
                  $locf: "$string"}, 
                date: {
                  $locf: "$date"}
            }
          }
        }]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: TestNumericWithSinglePartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: "$part1",
            output: {
                numeric: {
                  $locf: "$numeric"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestDateWithSinglePartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: "$part1",
            output: {
                date: {
                  $locf: "$date"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestStringWithSinglePartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: "$part1",
            output: {
                string: {
                  $locf: "$string"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestRandomTypeWithSinglePartition
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: "$part1",
            output: {
                randomType: {
                  $locf: "$randomType"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestNumericWithMultiplePartitions
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: {part1: "$part1", part2: "$part2"},
            output: {
                numeric: {
                  $locf: "$numeric"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestDateWithMultiplePartitions
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: {part1: "$part1", part2: "$part2"},
            output: {
                date: {
                  $locf: "$date"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestStringWithMultiplePartitions
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: {part1: "$part1", part2: "$part2"},
            output: {
                string: {
                  $locf: "$string"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestRandomTypeWithMultiplePartitions
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: {part1: "$part1", part2: "$part2"},
            output: {
                randomType: {
                  $locf: "$randomType"}
                  }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
    - OperationMetricsName: TestMultipleOutputWithMultiplePartitions
      OperationName: RunCommand
      OperationCommand:
        aggregate: Collection0
        pipeline: [{
          $setWindowFields: {
            sortBy: {_id: 1},
            partitionBy: {part1: "$part1", part2: "$part2"},
            output: {
                randomType: {
                  $locf: "$randomType"},
                string: {
                  $locf: "$string"},
                date: {
                  $locf: "$date"}
            }
          }
        }]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true


AutoRun:
- When:
    mongodb_setup:
      $eq: 
        - standalone
        - replica
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1

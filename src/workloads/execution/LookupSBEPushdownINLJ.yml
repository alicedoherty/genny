SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  This workload measures $lookup performance for scenarios that look up local integer key against
  foreign collection's integer key, when the foreign collections have multiple collection
  cardinalities such as 1500 / 3500 / 5500 / 7500 / 9500.

  While measuring performances, this workload collects numbers for either the SBE or the classic
  engine $lookup implementations, depending on environments that it runs on. The SBE $lookup
  implements the hash join and the (index) nested loop join but the classic $lookup implements
  only (index) nested loop join. So we can compare the SBE HJ / NLJ implementations to the classic
  engine NLJ implementation and the SBE INLJ implementation to the classic engine INLJ
  implementation.

  Numbers on the 'standalone-all-feature-flags' environment are for the SBE $lookup and numbers on
  the 'standalone' environment for the classic $lookup until the SBE $lookup pushdown feature will
  be turned on by default.

  Naming convention for collection names:
  Foreign_[DocumentSize]_[NoOfDocs]docs_[KeyGenerationMethod][NoOfUniqueKeys]g
  - DocumentSize: SmallDoc / LocalLargeDoc
  - NoOfDocs: 'k' means 1000 and 'docs' means documents
  - KeyGenerationMethod:
    . Inc: Monotonically increasing key values
    . Rand: Randomly generated key values
  - NoOfUniqueKeys: 'g' means groups or keys

  Name convention for OperationMetricsName:
  [LocalCollectionName]_[LocalJoinFieldType]_[ForeignCollectionName]_[ForeignJoinFieldType]

  In summary, this workload conducts testing for the following test matrix:
  - JoinType: HJ / NLJ / INLJ
  - ForeignCollectionCardinality: 1500 / 3500 / 5500 / 7500 / 9500
  - The local collection has 100k documents and its documents are small ones

  The workload consists of the following phases and actors:
    0. Cleans up database and turns off the SBE $lookup pushdown feature
    1. Loads data into the foreign collections
    2. Loads data into the local collections
    3. Calms down
    4. Builds indexes on foreign collections
    5. Calms down to isolate any trailing impacts from the load phase
    6. Runs and measures the classic INLJ lookups
    7. Turns on the SBE $lookup pushdown feature
    8. Runs and measures the SBE INLJ lookups

Keywords:
- INLJ
- join
- lookup
- aggregate
- sbe

# Defines the database name.
Database: &db lookup_sbe_pushdown_inlj

# Defines foreign collection names with increasing keys.
Foreign_SmallDoc_2kdocs_Inc2000g: &Foreign_SmallDoc_2kdocs_Inc2000g foreign_smalldoc_2kdocs_inc2000g
Foreign_SmallDoc_8kdocs_Inc8000g: &Foreign_SmallDoc_8kdocs_Inc8000g foreign_smalldoc_8kdocs_inc8000g
Foreign_SmallDoc_32kdocs_Inc32000g: &Foreign_SmallDoc_32kdocs_Inc32000g foreign_smalldoc_32kdocs_inc32000g
Foreign_SmallDoc_128kdocs_Inc128000g: &Foreign_SmallDoc_128kdocs_Inc128000g foreign_smalldoc_128kdocs_inc128000g
Foreign_SmallDoc_512kdocs_Inc512000g: &Foreign_SmallDoc_512kdocs_Inc512000g foreign_smalldoc_512kdocs_inc512000g

# Defines foreign collection names with duplicated keys.
# 64 duplicates per each key
Foreign_SmallDoc_128kdocs_Inc2000g: &Foreign_SmallDoc_128kdocs_Inc2000g foreign_smalldoc_128kdocs_inc2000g
# 16 duplicates per each key
Foreign_SmallDoc_128kdocs_Inc8000g: &Foreign_SmallDoc_128kdocs_Inc8000g foreign_smalldoc_128kdocs_inc8000g
# 4 duplicates per each key
Foreign_SmallDoc_128kdocs_Inc32000g: &Foreign_SmallDoc_128kdocs_Inc32000g foreign_smalldoc_128kdocs_inc32000g

# Defines foreign collection names with random keys.
Foreign_SmallDoc_2kdocs_Rand2000g: &Foreign_SmallDoc_2kdocs_Rand2000g foreign_smalldoc_2kdocs_rand2000g
Foreign_SmallDoc_4kdocs_Rand8000g: &Foreign_SmallDoc_4kdocs_Rand8000g foreign_smalldoc_4kdocs_rand8000g
Foreign_SmallDoc_8kdocs_Rand32000g: &Foreign_SmallDoc_8kdocs_Rand32000g foreign_smalldoc_8kdocs_rand32000g
Foreign_SmallDoc_16kdocs_Rand128000g: &Foreign_SmallDoc_16kdocs_Rand128000g foreign_smalldoc_16kdocs_rand128000g
Foreign_SmallDoc_32kdocs_Rand512000g: &Foreign_SmallDoc_32kdocs_Rand512000g foreign_smalldoc_32kdocs_rand512000g

# Defines the local collection names.
Local_SmallDoc_256kdocs_Rand2000g: &Local_SmallDoc_256kdocs_Rand2000g local_smalldoc_256kdocs_rand2000g
Local_SmallDoc_512kdocs_Rand2000g: &Local_SmallDoc_512kdocs_Rand2000g local_smalldoc_512kdocs_rand2000g
Local_SmallDoc_1024kdocs_Rand2000g: &Local_SmallDoc_1024kdocs_Rand2000g local_smalldoc_1024kdocs_rand2000g
Local_SmallDoc_2048kdocs_Rand2000g: &Local_SmallDoc_2048kdocs_Rand2000g local_smalldoc_2048kdocs_rand2000g
Local_SmallDoc_2048kdocs_Rand8000g: &Local_SmallDoc_2048kdocs_Rand8000g local_smalldoc_2048kdocs_rand8000g
Local_SmallDoc_2048kdocs_Rand32000g: &Local_SmallDoc_2048kdocs_Rand32000g local_smalldoc_2048kdocs_rand32000g
Local_SmallDoc_2048kdocs_Rand128000g: &Local_SmallDoc_2048kdocs_Rand128000g local_smalldoc_2048kdocs_rand128000g
Local_SmallDoc_2048kdocs_Rand512000g: &Local_SmallDoc_2048kdocs_Rand512000g local_smalldoc_2048kdocs_rand512000g

# Defines the local collection document generators which are used by 'LoadLocalXXX' actors. See
# 'LocalSmallDocRandKeyTemplate' to understand how each doc is filled.
Local_SmallDoc_Rand2000g: &Local_SmallDoc_Rand2000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 2000

Local_SmallDoc_Rand8000g: &Local_SmallDoc_Rand8000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 8000

Local_SmallDoc_Rand32000g: &Local_SmallDoc_Rand32000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 32000

Local_SmallDoc_Rand128000g: &Local_SmallDoc_Rand128000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 128000

Local_SmallDoc_Rand512000g: &Local_SmallDoc_Rand512000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 512000

# Defines foreign collection document generators which are used by 'LoadForeignXXX' actor. See
# 'ForeignSmallDocIncKeyTemplate' to understand how each doc is filled.
Foreign_SmallDoc_Inc2000g: &Foreign_SmallDoc_Inc2000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 2000

Foreign_SmallDoc_Inc8000g: &Foreign_SmallDoc_Inc8000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 8000

Foreign_SmallDoc_Inc32000g: &Foreign_SmallDoc_Inc32000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 32000

Foreign_SmallDoc_Inc128000g: &Foreign_SmallDoc_Inc128000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 128000

Foreign_SmallDoc_Inc512000g: &Foreign_SmallDoc_Inc512000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 512000

# Foreign_SmallDoc_Rand2000g: &Foreign_SmallDoc_Rand2000g
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: ForeignSmallDocRandKeyTemplate
#     Parameters:
#       nkeys: 2000
#
# Foreign_SmallDoc_Rand8000g: &Foreign_SmallDoc_Rand8000g
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: ForeignSmallDocRandKeyTemplate
#     Parameters:
#       nkeys: 4000
#
# Foreign_SmallDoc_Rand32000g: &Foreign_SmallDoc_Rand32000g
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: ForeignSmallDocRandKeyTemplate
#     Parameters:
#       nkeys: 8000
#
# Foreign_SmallDoc_Rand128000g: &Foreign_SmallDoc_Rand128000g
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: ForeignSmallDocRandKeyTemplate
#     Parameters:
#       nkeys: 16000
#
# Foreign_SmallDoc_Rand512000g: &Foreign_SmallDoc_Rand512000g
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: ForeignSmallDocRandKeyTemplate
#     Parameters:
#       nkeys: 32000

# Defines NLJ lookup commands which are used by 'NLJLookup' / 'INLJLookup' actors. See
# 'NLJLookupCmdTemplate' for details. The command template can be used for INLJ too because INLJ
# will be enabled when the foreign join field is indexed.
NLJLookupForeign2000Local256kCmd: &NLJLookupForeign2000Local256kCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_256kdocs_Rand2000g
      f: *Foreign_SmallDoc_2kdocs_Inc2000g

NLJLookupForeign2000Local512kCmd: &NLJLookupForeign2000Local512kCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_512kdocs_Rand2000g
      f: *Foreign_SmallDoc_2kdocs_Inc2000g

NLJLookupForeign2000Local1024kCmd: &NLJLookupForeign2000Local1024kCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_1024kdocs_Rand2000g
      f: *Foreign_SmallDoc_2kdocs_Inc2000g

NLJLookupForeign2000Cmd: &NLJLookupForeign2000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand2000g
      f: *Foreign_SmallDoc_2kdocs_Inc2000g

NLJLookupForeign8000Cmd: &NLJLookupForeign8000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand8000g
      f: *Foreign_SmallDoc_8kdocs_Inc8000g

NLJLookupForeign32000Cmd: &NLJLookupForeign32000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand32000g
      f: *Foreign_SmallDoc_32kdocs_Inc32000g

NLJLookupForeign128000Cmd: &NLJLookupForeign128000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand128000g
      f: *Foreign_SmallDoc_128kdocs_Inc128000g

NLJLookupForeign128000OnStrKeyCmd: &NLJLookupForeign128000OnStrKeyCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand128000g
      f: *Foreign_SmallDoc_128kdocs_Inc128000g
      lk: str_key
      k: str_key

NLJLookupForeign128000OnLargeStrKeyCmd: &NLJLookupForeign128000OnLargeStrKeyCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand128000g
      f: *Foreign_SmallDoc_128kdocs_Inc128000g
      lk: lstr_key
      k: lstr_key

NLJLookupForeign128000_2000gCmd: &NLJLookupForeign128000_2000gCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand2000g
      f: *Foreign_SmallDoc_128kdocs_Inc2000g

NLJLookupForeign128000_8000gCmd: &NLJLookupForeign128000_8000gCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand8000g
      f: *Foreign_SmallDoc_128kdocs_Inc8000g

NLJLookupForeign128000_32000gCmd: &NLJLookupForeign128000_32000gCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand32000g
      f: *Foreign_SmallDoc_128kdocs_Inc32000g

NLJLookupForeign512000Cmd: &NLJLookupForeign512000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_2048kdocs_Rand512000g
      f: *Foreign_SmallDoc_512kdocs_Inc512000g

# NLJLookupForeignRand15000Cmd: &NLJLookupForeignRand15000Cmd
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: NLJLookupCmdTemplate
#     Parameters:
#       l: *Local_SmallDoc_2048kdocs_Rand2000g
#       f: *Foreign_SmallDoc_2kdocs_Rand2000g
#
# NLJLookupForeignRand35000Cmd: &NLJLookupForeignRand35000Cmd
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: NLJLookupCmdTemplate
#     Parameters:
#       l: *Local_SmallDoc_2048kdocs_Rand8000g
#       f: *Foreign_SmallDoc_4kdocs_Rand8000g
#
# NLJLookupForeignRand55000Cmd: &NLJLookupForeignRand55000Cmd
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: NLJLookupCmdTemplate
#     Parameters:
#       l: *Local_SmallDoc_2048kdocs_Rand32000g
#       f: *Foreign_SmallDoc_8kdocs_Rand32000g
#
# NLJLookupForeignRand75000Cmd: &NLJLookupForeignRand75000Cmd
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: NLJLookupCmdTemplate
#     Parameters:
#       l: *Local_SmallDoc_2048kdocs_Rand128000g
#       f: *Foreign_SmallDoc_16kdocs_Rand128000g
#
# NLJLookupForeignRand95000Cmd: &NLJLookupForeignRand95000Cmd
#   LoadConfig:
#     Path: "../../phases/execution/LookupCommands.yml"
#     Key: NLJLookupCmdTemplate
#     Parameters:
#       l: *Local_SmallDoc_2048kdocs_Rand512000g
#       f: *Foreign_SmallDoc_32kdocs_Rand512000g

# Defines test operations for '[Classic|SBE]_INLJLookup' actors.
INLJTestOperations: &INLJTestOperations
- OperationMetricsName: Local_SmallDoc_256kdocs_Rand2000g_IntTopField_Foreign_SmallDoc_2kdocs_Inc2000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign2000Local256kCmd
- OperationMetricsName: Local_SmallDoc_512kdocs_Rand2000g_IntTopField_Foreign_SmallDoc_2kdocs_Inc2000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign2000Local512kCmd
- OperationMetricsName: Local_SmallDoc_1024kdocs_Rand2000g_IntTopField_Foreign_SmallDoc_2kdocs_Inc2000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign2000Local1024kCmd
- OperationMetricsName: Local_SmallDoc_2048kdocs_Rand2000g_IntTopField_Foreign_SmallDoc_2kdocs_Inc2000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign2000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand8000g_IntTopField_Foreign_SmallDoc_8kdocs_Inc8000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign8000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand32000g_IntTopField_Foreign_SmallDoc_32kdocs_Inc32000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign32000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand128000g_IntTopField_Foreign_SmallDoc_128kdocs_Inc128000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign128000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand128000g_StrTopField_Foreign_SmallDoc_128kdocs_Inc128000g_StrTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign128000OnStrKeyCmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand128000g_LargeStrTopField_Foreign_SmallDoc_128kdocs_Inc128000g_LargeStrTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign128000OnLargeStrKeyCmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand2000g_IntTopField_Foreign_SmallDoc_128kdocs_Inc2000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign128000_2000gCmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand8000g_IntTopField_Foreign_SmallDoc_128kdocs_Inc8000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign128000_8000gCmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand32000g_IntTopField_Foreign_SmallDoc_128kdocs_Inc32000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign128000_32000gCmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand512000g_IntTopField_Foreign_SmallDoc_512kdocs_Inc512000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeign512000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand2000g_IntTopField_Foreign_SmallDoc_2kdocs_Rand2000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeignRand15000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand8000g_IntTopField_Foreign_SmallDoc_4kdocs_Rand8000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeignRand35000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand32000g_IntTopField_Foreign_SmallDoc_8kdocs_Rand32000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeignRand55000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand128000g_IntTopField_Foreign_SmallDoc_16kdocs_Rand128000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeignRand75000Cmd
# - OperationMetricsName: Local_SmallDoc_2048kdocs_Rand512000g_IntTopField_Foreign_SmallDoc_32kdocs_Rand512000g_IntTopField
#   OperationName: RunCommand
#   OperationCommand: *NLJLookupForeignRand95000Cmd

IndexSpec: &IndexSpec
- {key: {int_key: 1}, name: "idx"}
- {key: {str_key: 1}, name: "str_idx"}
- {key: {lstr_key: 1}, name: "lstr_idx"}

16LocalSmallDocRand2000gDocuments: &16LocalSmallDocRand2000gDocuments
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g
- *Local_SmallDoc_Rand2000g

# Defines how many times each test operation is executed.
TestRepeatCount: &TestRepeatCount 10

Nop: &Nop {Nop: true}

Actors:
# The 'Setup' actor drops the database in the 0th phase and turns off the SBE $lookup pushdown
# feature in the 1st phase.
- Name: Setup
  Type: RunCommand
  Database: *db
  Thread: 1
  Phases:
  - Repeat: 1
    Threads: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand: {dropDatabase: 1}
  - Repeat: 1
    Threads: 1
    Database: admin
    Operations:
    - OperationName: AdminCommand
      OperationCommand: {setParameter: 1, internalQueryForceClassicEngine: true}
  - Phase: 2..8
    Nop: true

# The 'LoadForeignXXX' actors run in the 1st phase.
- Name: LoadForeign_SmallDoc_2kdocs_Inc2000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 2000
    Threads: 1
    Collection: *Foreign_SmallDoc_2kdocs_Inc2000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc2000g
  - Phase: 2..8
    Nop: true

# - Name: LoadForeign_SmallDoc_8kdocs_Inc8000g
#   Type: CrudActor
#   Database: *db
#   Threads: 1
#   Phases:
#   - *Nop
#   - Repeat: 8000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_8kdocs_Inc8000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Inc8000g
#   - Phase: 2..8
#     Nop: true
# 
# - Name: LoadForeign_SmallDoc_32kdocs_Inc32000g
#   Type: CrudActor
#   Database: *db
#   Threads: 1
#   Phases:
#   - *Nop
#   - Repeat: 32000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_32kdocs_Inc32000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Inc32000g
#   - Phase: 2..8
#     Nop: true
# 
# - Name: LoadForeign_SmallDoc_128kdocs_Inc128000g
#   Type: CrudActor
#   Database: *db
#   Threads: 1
#   Phases:
#   - *Nop
#   - Repeat: 128000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_128kdocs_Inc128000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Inc128000g
#   - Phase: 2..8
#     Nop: true
# 
# - Name: LoadForeign_SmallDoc_512kdocs_Inc512000g
#   Type: CrudActor
#   Database: *db
#   Threads: 1
#   Phases:
#   - *Nop
#   - Repeat: 512000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_512kdocs_Inc512000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Inc512000g
#   - Phase: 2..8
#     Nop: true

# - Name: LoadForeign_SmallDoc_2kdocs_Rand2000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - Repeat: 3000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_2kdocs_Rand2000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Rand2000g
#   - Phase: 2..8
#     Nop: true
#
# - Name: LoadForeign_SmallDoc_4kdocs_Rand8000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - Repeat: 7000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_4kdocs_Rand8000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Rand8000g
#   - Phase: 2..8
#     Nop: true
#
# - Name: LoadForeign_SmallDoc_8kdocs_Rand32000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - Repeat: 11000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_8kdocs_Rand32000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Rand32000g
#   - Phase: 2..8
#     Nop: true
#
# - Name: LoadForeign_SmallDoc_16kdocs_Rand128000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - Repeat: 15000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_16kdocs_Rand128000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Rand128000g
#   - Phase: 2..8
#     Nop: true
#
# - Name: LoadForeign_SmallDoc_32kdocs_Rand512000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - Repeat: 19000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_32kdocs_Rand512000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Rand512000g
#   - Phase: 2..8
#     Nop: true

# The 'LoadLocalXXX' actors for monotonically increasing keys run in the 2nd phase.
- Name: LoadLocal_SmallDoc_256kdocs_Rand2000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 16000
    Threads: 1
    Collection: *Local_SmallDoc_256kdocs_Rand2000g
    Operations:
    - OperationName: insertMany
      OperationCommand:
        Documents: *16LocalSmallDocRand2000gDocuments
  - Phase: 3..8
    Nop: true

- Name: LoadLocal_SmallDoc_512kdocs_Rand2000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 32000
    Threads: 1
    Collection: *Local_SmallDoc_512kdocs_Rand2000g
    Operations:
    - OperationName: insertMany
      OperationCommand:
        Documents: *16LocalSmallDocRand2000gDocuments
  - Phase: 3..8
    Nop: true

- Name: LoadLocal_SmallDoc_1048kdocs_Rand2000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 64000
    Threads: 1
    Collection: *Local_SmallDoc_1024kdocs_Rand2000g
    Operations:
    - OperationName: insertMany
      OperationCommand:
        Documents: *16LocalSmallDocRand2000gDocuments
  - Phase: 3..8
    Nop: true

- Name: LoadLocal_SmallDoc_2048kdocs_Rand2000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 128000
    Threads: 1
    Collection: *Local_SmallDoc_2048kdocs_Rand2000g
    Operations:
    - OperationName: insertMany
      OperationCommand:
        Documents: *16LocalSmallDocRand2000gDocuments
  - Phase: 3..8
    Nop: true

# - Name: LoadLocal_SmallDoc_2048kdocs_Rand8000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - *Nop
#   - Repeat: 409600
#     Threads: 1
#     Collection: *Local_SmallDoc_2048kdocs_Rand8000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Local_SmallDoc_Rand8000g
#   - Phase: 3..8
#     Nop: true
# 
# - Name: LoadLocal_SmallDoc_2048kdocs_Rand32000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - *Nop
#   - Repeat: 409600
#     Threads: 1
#     Collection: *Local_SmallDoc_2048kdocs_Rand32000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Local_SmallDoc_Rand32000g
#   - Phase: 3..8
#     Nop: true
# 
# - Name: LoadLocal_SmallDoc_2048kdocs_Rand128000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - *Nop
#   - Repeat: 409600
#     Threads: 1
#     Collection: *Local_SmallDoc_2048kdocs_Rand128000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Local_SmallDoc_Rand128000g
#   - Phase: 3..8
#     Nop: true
# 
# - Name: LoadLocal_SmallDoc_2048kdocs_Rand512000g
#   Type: CrudActor
#   Database: *db
#   Threads: 5
#   Phases:
#   - *Nop
#   - *Nop
#   - Repeat: 409600
#     Threads: 1
#     Collection: *Local_SmallDoc_2048kdocs_Rand512000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Local_SmallDoc_Rand512000g
#   - Phase: 3..8
#     Nop: true

# The 'Quiesce1' actors for random keys run in the 3rd phase. This actor is just a placeholder.
# Enable either Quiesce1 actor or LoadForeign_SmallDoc_128kdocs_Inc8000g and LoadForeign_SmallDoc_128kdocs_Inc32000g actors
- Name: Quiesce1
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - Phase: 0..2
    Nop: true
  - Repeat: 1
  - Phase: 4..8
    Nop: true

# The 'LoadLocalXXX' actors for random keys run in the 3rd phase.
# - Name: LoadForeign_SmallDoc_128kdocs_Inc2000g
#   Type: CrudActor
#   Threads: 16
#   Database: *db
#   Phases:
#   - Phase: 0..2
#     Nop: true
#   - Repeat: 2000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_128kdocs_Inc2000g
#     Operations:
#     - OperationName: insertMany
#       OperationCommand:
#         Documents:
#         - *Foreign_SmallDoc_Inc2000g
#         - *Foreign_SmallDoc_Inc2000g
#         - *Foreign_SmallDoc_Inc2000g
#         - *Foreign_SmallDoc_Inc2000g
#   - Phase: 4..8
#     Nop: true
# - Name: LoadForeign_SmallDoc_128kdocs_Inc8000g
#   Type: CrudActor
#   Threads: 16
#   Database: *db
#   Phases:
#   - Phase: 0..2
#     Nop: true
#   - Repeat: 8000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_128kdocs_Inc8000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Inc8000g
#   - Phase: 4..8
#     Nop: true
# - Name: LoadForeign_SmallDoc_128kdocs_Inc32000g
#   Type: CrudActor
#   Threads: 4
#   Database: *db
#   Phases:
#   - Phase: 0..2
#     Nop: true
#   - Repeat: 32000
#     Threads: 1
#     Collection: *Foreign_SmallDoc_128kdocs_Inc32000g
#     Operations:
#     - OperationName: insertOne
#       OperationCommand:
#         Document: *Foreign_SmallDoc_Inc32000g
#   - Phase: 4..8
#     Nop: true

# The 'BuildIndexes' actor builds indexes on 'int_key' / 'str_key' join fields of foreign
# collections so that INLJ lookup performances can be measured and runs in the 4th phase.
- Name: BuildIndexes
  Type: RunCommand
  Phases:
  - Phase: 0..3
    Nop: true
  - Repeat: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_2kdocs_Inc2000g
        indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_8kdocs_Inc8000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_32kdocs_Inc32000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_128kdocs_Inc128000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_128kdocs_Inc2000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_128kdocs_Inc8000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_128kdocs_Inc32000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_512kdocs_Inc512000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_2kdocs_Rand2000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_4kdocs_Rand8000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_8kdocs_Rand32000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_16kdocs_Rand128000g
#         indexes: *IndexSpec
#     - OperationName: RunCommand
#       OperationCommand:
#         createIndexes: *Foreign_SmallDoc_32kdocs_Rand512000g
#         indexes: *IndexSpec
  - Phase: 5..8
    Nop: true

# The 'Quiesce' actor calms down to avoid any trailing impacts from the previous phase and runs
# in the 5th.
- Name: Quiesce2
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - Phase: 0..4
    Nop: true
  - Repeat: 1
  - Phase: 6..8
    Nop: true

# The 'Classic_INLJLookup' actor measures the classic INLJ lookup performances and runs in the 6th
# phase.
- Name: Classic_INLJLookup
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..5
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *INLJTestOperations
  - *Nop
  - *Nop

# The 'TurnOnFeature' actor turns on the feature and runs in the 7th phase.
- Name: TurnOnFeature
  Type: RunCommand
  Database: admin
  Phases:
  - Phase: 0..6
    Nop: true
  - Repeat: 1
    Database: admin
    Operations:
    - OperationName: AdminCommand
      OperationCommand: {setParameter: 1, internalQueryForceClassicEngine: false}
  - *Nop

# The 'SBE_INLJLookup' actor measures the SBE INLJ lookup performances and runs in the 8th phase.
- Name: SBE_INLJLookup
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..7
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *INLJTestOperations

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-all-feature-flags

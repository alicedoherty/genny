SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  This workload measures $lookup performance for scenarios that look up local integer key against
  foreign collection's integer key, when the foreign collections have multiple collection
  cardinalities such as 1500 / 3500 / 5500 / 7500 / 9500.

  While measuring performances, this workload collects numbers for either the SBE or the classic
  engine $lookup implementations, depending on environments that it runs on. The SBE $lookup
  implements the hash join and the (index) nested loop join but the classic $lookup implements
  only (index) nested loop join. So we can compare the SBE HJ / NLJ implementations to the classic
  engine NLJ implementation and the SBE INLJ implementation to the classic engine INLJ
  implementation.

  Numbers on the 'standalone-all-feature-flags' environment are for the SBE $lookup and numbers on
  the 'standalone' environment for the classic $lookup until the SBE $lookup pushdown feature will
  be turned on by default.

  Naming convention for collection names:
  Foreign_[DocumentSize]_[NoOfDocs]docs_[KeyGenerationMethod][NoOfUniqueKeys]g
  - DocumentSize: SmallDoc / LocalLargeDoc
  - NoOfDocs: 'k' means 1000 and 'docs' means documents
  - KeyGenerationMethod:
    . Inc: Monotonically increasing key values
    . Rand: Randomly generated key values
  - NoOfUniqueKeys: 'g' means groups

  Name convention for OperationMetricsName:
  [LocalCollectionName]_[LocalJoinFieldType]_[ForeignCollectionName]_[ForeignJoinFieldType]

  In summary, this workload conducts testing for the following test matrix:
  - JoinType: HJ / NLJ / INLJ
  - ForeignCollectionCardinality: 1500 / 3500 / 5500 / 7500 / 9500
  - The local collection has 100k documents and its documents are small ones

  The workload consists of the following phases and actors:
    0. Cleans up database and turns off the SBE $lookup pushdown feature
    1. Loads data into the foreign collections
    2. Loads data into the local collections
    3. Calms down
    4. Builds indexes on foreign collections
    5. Calms down to isolate any trailing impacts from the load phase
    6. Runs and measures the classic INLJ lookups
    7. Turns on the SBE $lookup pushdown feature
    8. Runs and measures the SBE INLJ lookups

Keywords:
- INLJ
- join
- lookup
- aggregate
- sbe

# Defines the database name.
Database: &db lookup_sbe_pushdown_inlj

# Defines foreign collection names with increasing keys.
Foreign_SmallDoc_15kdocs_Inc15000g: &Foreign_SmallDoc_15kdocs_Inc15000g foreign_smalldoc_15kdocs_inc15000g
Foreign_SmallDoc_35kdocs_Inc35000g: &Foreign_SmallDoc_35kdocs_Inc35000g foreign_smalldoc_35kdocs_inc35000g
Foreign_SmallDoc_55kdocs_Inc55000g: &Foreign_SmallDoc_55kdocs_Inc55000g foreign_smalldoc_55kdocs_inc55000g
Foreign_SmallDoc_75kdocs_Inc75000g: &Foreign_SmallDoc_75kdocs_Inc75000g foreign_smalldoc_75kdocs_inc75000g
Foreign_SmallDoc_95kdocs_Inc95000g: &Foreign_SmallDoc_95kdocs_Inc95000g foreign_smalldoc_95kdocs_inc95000g

# Defines foreign collection names with random keys.
Foreign_SmallDoc_15kdocs_Rand15000g: &Foreign_SmallDoc_15kdocs_Rand15000g foreign_smalldoc_15kdocs_rand15000g
Foreign_SmallDoc_35kdocs_Rand35000g: &Foreign_SmallDoc_35kdocs_Rand35000g foreign_smalldoc_35kdocs_rand35000g
Foreign_SmallDoc_55kdocs_Rand55000g: &Foreign_SmallDoc_55kdocs_Rand55000g foreign_smalldoc_55kdocs_rand55000g
Foreign_SmallDoc_75kdocs_Rand75000g: &Foreign_SmallDoc_75kdocs_Rand75000g foreign_smalldoc_75kdocs_rand75000g
Foreign_SmallDoc_95kdocs_Rand95000g: &Foreign_SmallDoc_95kdocs_Rand95000g foreign_smalldoc_95kdocs_rand95000g

# Defines the local collection names.
Local_SmallDoc_400kdocs_Rand15000g: &Local_SmallDoc_400kdocs_Rand15000g local_smalldoc_400kdocs_rand15000g
Local_SmallDoc_400kdocs_Rand35000g: &Local_SmallDoc_400kdocs_Rand35000g local_smalldoc_400kdocs_rand35000g
Local_SmallDoc_400kdocs_Rand55000g: &Local_SmallDoc_400kdocs_Rand55000g local_smalldoc_400kdocs_rand55000g
Local_SmallDoc_400kdocs_Rand75000g: &Local_SmallDoc_400kdocs_Rand75000g local_smalldoc_400kdocs_rand75000g
Local_SmallDoc_400kdocs_Rand95000g: &Local_SmallDoc_400kdocs_Rand95000g local_smalldoc_400kdocs_rand95000g

# Defines the local collection document generators which are used by 'LoadLocalXXX' actors. See
# 'LocalSmallDocRandKeyTemplate' to understand how each doc is filled.
Local_SmallDoc_Rand15000g: &Local_SmallDoc_Rand15000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 15000

Local_SmallDoc_Rand35000g: &Local_SmallDoc_Rand35000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 35000

Local_SmallDoc_Rand55000g: &Local_SmallDoc_Rand55000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 55000

Local_SmallDoc_Rand75000g: &Local_SmallDoc_Rand75000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 75000

Local_SmallDoc_Rand95000g: &Local_SmallDoc_Rand95000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocRandKeyTemplate
    Parameters:
      nkeys: 95000

# Defines foreign collection document generators which are used by 'LoadForeignXXX' actor. See
# 'ForeignSmallDocIncKeyTemplate' to understand how each doc is filled.
Foreign_SmallDoc_Inc15000g: &Foreign_SmallDoc_Inc15000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 15000

Foreign_SmallDoc_Inc35000g: &Foreign_SmallDoc_Inc35000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 35000

Foreign_SmallDoc_Inc55000g: &Foreign_SmallDoc_Inc55000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 55000

Foreign_SmallDoc_Inc75000g: &Foreign_SmallDoc_Inc75000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 75000

Foreign_SmallDoc_Inc95000g: &Foreign_SmallDoc_Inc95000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocIncKeyTemplate
    Parameters:
      nkeys: 95000

Foreign_SmallDoc_Rand15000g: &Foreign_SmallDoc_Rand15000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocRandKeyTemplate
    Parameters:
      nkeys: 15000

Foreign_SmallDoc_Rand35000g: &Foreign_SmallDoc_Rand35000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocRandKeyTemplate
    Parameters:
      nkeys: 35000

Foreign_SmallDoc_Rand55000g: &Foreign_SmallDoc_Rand55000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocRandKeyTemplate
    Parameters:
      nkeys: 55000

Foreign_SmallDoc_Rand75000g: &Foreign_SmallDoc_Rand75000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocRandKeyTemplate
    Parameters:
      nkeys: 75000

Foreign_SmallDoc_Rand95000g: &Foreign_SmallDoc_Rand95000g
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocRandKeyTemplate
    Parameters:
      nkeys: 95000

# Defines NLJ lookup commands which are used by 'NLJLookup' / 'INLJLookup' actors. See
# 'NLJLookupCmdTemplate' for details. The command template can be used for INLJ too because INLJ
# will be enabled when the foreign join field is indexed.
NLJLookupForeign15000Cmd: &NLJLookupForeign15000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand15000g
      f: *Foreign_SmallDoc_15kdocs_Inc15000g

NLJLookupForeign35000Cmd: &NLJLookupForeign35000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand35000g
      f: *Foreign_SmallDoc_35kdocs_Inc35000g

NLJLookupForeign55000Cmd: &NLJLookupForeign55000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand55000g
      f: *Foreign_SmallDoc_55kdocs_Inc55000g

NLJLookupForeign75000Cmd: &NLJLookupForeign75000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand75000g
      f: *Foreign_SmallDoc_75kdocs_Inc75000g

NLJLookupForeign95000Cmd: &NLJLookupForeign95000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand95000g
      f: *Foreign_SmallDoc_95kdocs_Inc95000g

NLJLookupForeignRand15000Cmd: &NLJLookupForeignRand15000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand15000g
      f: *Foreign_SmallDoc_15kdocs_Rand15000g

NLJLookupForeignRand35000Cmd: &NLJLookupForeignRand35000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand35000g
      f: *Foreign_SmallDoc_35kdocs_Rand35000g

NLJLookupForeignRand55000Cmd: &NLJLookupForeignRand55000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand55000g
      f: *Foreign_SmallDoc_55kdocs_Rand55000g

NLJLookupForeignRand75000Cmd: &NLJLookupForeignRand75000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand75000g
      f: *Foreign_SmallDoc_75kdocs_Rand75000g

NLJLookupForeignRand95000Cmd: &NLJLookupForeignRand95000Cmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: NLJLookupCmdTemplate
    Parameters:
      l: *Local_SmallDoc_400kdocs_Rand95000g
      f: *Foreign_SmallDoc_95kdocs_Rand95000g

# Defines test operations for '[Classic|SBE]_INLJLookup' actors.
INLJTestOperations: &INLJTestOperations
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand15000g_IntTopField_Foreign_SmallDoc_15kdocs_Inc15000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign15000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand35000g_IntTopField_Foreign_SmallDoc_35kdocs_Inc35000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign35000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand55000g_IntTopField_Foreign_SmallDoc_55kdocs_Inc55000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign55000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand75000g_IntTopField_Foreign_SmallDoc_75kdocs_Inc75000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign75000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand95000g_IntTopField_Foreign_SmallDoc_95kdocs_Inc95000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeign95000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand15000g_IntTopField_Foreign_SmallDoc_15kdocs_Rand15000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeignRand15000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand35000g_IntTopField_Foreign_SmallDoc_35kdocs_Rand35000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeignRand35000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand55000g_IntTopField_Foreign_SmallDoc_55kdocs_Rand55000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeignRand55000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand75000g_IntTopField_Foreign_SmallDoc_75kdocs_Rand75000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeignRand75000Cmd
- OperationMetricsName: Local_SmallDoc_400kdocs_Rand95000g_IntTopField_Foreign_SmallDoc_95kdocs_Rand95000g_IntTopField
  OperationName: RunCommand
  OperationCommand: *NLJLookupForeignRand95000Cmd

# Defines how many times each test operation is executed.
TestRepeatCount: &TestRepeatCount 10

Actors:
# The 'Setup' actor drops the database in the 0th phase and turns off the SBE $lookup pushdown
# feature in the 1st phase.
- Name: Setup
  Type: RunCommand
  Database: *db
  Thread: 1
  Phases:
  - Repeat: 1
    Threads: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand: {dropDatabase: 1}
  - Repeat: 1
    Threads: 1
    Database: admin
    Operations:
    - OperationName: AdminCommand
      OperationCommand: {setParameter: 1, internalEnableMultipleAutoGetCollections: false}
  - Phase: 2..8
    Nop: true

# The 'LoadForeignXXX' actors run in the 1st phase.
- Name: LoadForeign_SmallDoc_15kdocs_Inc15000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - &Nop {Nop: true}
  - Repeat: 15000
    Threads: 1
    Collection: *Foreign_SmallDoc_15kdocs_Inc15000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc15000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_35kdocs_Inc35000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 35000
    Threads: 1
    Collection: *Foreign_SmallDoc_35kdocs_Inc35000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc35000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_55kdocs_Inc55000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 55000
    Threads: 1
    Collection: *Foreign_SmallDoc_55kdocs_Inc55000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc55000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_75kdocs_Inc75000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 75000
    Threads: 1
    Collection: *Foreign_SmallDoc_75kdocs_Inc75000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc75000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_95kdocs_Inc95000g
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 95000
    Threads: 1
    Collection: *Foreign_SmallDoc_95kdocs_Inc95000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Inc95000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_15kdocs_Rand15000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - Repeat: 3000
    Threads: 1
    Collection: *Foreign_SmallDoc_15kdocs_Rand15000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Rand15000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_35kdocs_Rand35000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - Repeat: 7000
    Threads: 1
    Collection: *Foreign_SmallDoc_35kdocs_Rand35000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Rand35000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_55kdocs_Rand55000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - Repeat: 11000
    Threads: 1
    Collection: *Foreign_SmallDoc_55kdocs_Rand55000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Rand55000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_75kdocs_Rand75000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - Repeat: 15000
    Threads: 1
    Collection: *Foreign_SmallDoc_75kdocs_Rand75000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Rand75000g
  - Phase: 2..8
    Nop: true

- Name: LoadForeign_SmallDoc_95kdocs_Rand95000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - Repeat: 19000
    Threads: 1
    Collection: *Foreign_SmallDoc_95kdocs_Rand95000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Foreign_SmallDoc_Rand95000g
  - Phase: 2..8
    Nop: true

# The 'LoadLocalXXX' actors for monotonically increasing keys run in the 2nd phase.
- Name: LoadLocal_SmallDoc_400kdocs_Rand15000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - *Nop
  - Repeat: 80000
    Threads: 1
    Collection: *Local_SmallDoc_400kdocs_Rand15000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand15000g
  - Phase: 3..8
    Nop: true

- Name: LoadLocal_SmallDoc_400kdocs_Rand35000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - *Nop
  - Repeat: 80000
    Threads: 1
    Collection: *Local_SmallDoc_400kdocs_Rand35000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand35000g
  - Phase: 3..8
    Nop: true

- Name: LoadLocal_SmallDoc_400kdocs_Rand55000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - *Nop
  - Repeat: 80000
    Threads: 1
    Collection: *Local_SmallDoc_400kdocs_Rand55000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand55000g
  - Phase: 3..8
    Nop: true

- Name: LoadLocal_SmallDoc_400kdocs_Rand75000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - *Nop
  - Repeat: 80000
    Threads: 1
    Collection: *Local_SmallDoc_400kdocs_Rand75000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand75000g
  - Phase: 3..8
    Nop: true

- Name: LoadLocal_SmallDoc_400kdocs_Rand95000g
  Type: CrudActor
  Database: *db
  Threads: 5
  Phases:
  - *Nop
  - *Nop
  - Repeat: 80000
    Threads: 1
    Collection: *Local_SmallDoc_400kdocs_Rand95000g
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *Local_SmallDoc_Rand95000g
  - Phase: 3..8
    Nop: true

# The 'LoadLocalXXX' actors for random keys run in the 3rd phase.
- Name: Quiesce1
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - Phase: 0..2
    Nop: true
  - Repeat: 1
  - Phase: 4..8
    Nop: true

# The 'BuildIndexes' actor builds indexes on 'int_key' / 'str_key' join fields of foreign
# collections so that INLJ lookup performances can be measured and runs in the 4th phase.
- Name: BuildIndexes
  Type: RunCommand
  Phases:
  - Phase: 0..3
    Nop: true
  - Repeat: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_15kdocs_Inc15000g
        indexes: &IndexSpec [{key: {"int_key": 1}, name: "idx"}, {key: {str_key: 1}, name: "str_idx"}]
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_35kdocs_Inc35000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_55kdocs_Inc55000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_75kdocs_Inc75000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_95kdocs_Inc95000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_15kdocs_Rand15000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_35kdocs_Rand35000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_55kdocs_Rand55000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_75kdocs_Rand75000g
        indexes: *IndexSpec
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *Foreign_SmallDoc_95kdocs_Rand95000g
        indexes: *IndexSpec
  - Phase: 5..8
    Nop: true

# The 'Quiesce' actor calms down to avoid any trailing impacts from the previous phase and runs
# in the 5th.
- Name: Quiesce2
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - Phase: 0..4
    Nop: true
  - Repeat: 1
  - Phase: 6..8
    Nop: true

# The 'Classic_INLJLookup' actor measures the classic INLJ lookup performances and runs in the 6th
# phase.
- Name: Classic_INLJLookup
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..5
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *INLJTestOperations
  - *Nop
  - *Nop

# The 'TurnOnFeature' actor turns on the feature and runs in the 7th phase.
- Name: TurnOnFeature
  Type: RunCommand
  Database: admin
  Phases:
  - Phase: 0..6
    Nop: true
  - Repeat: 1
    Database: admin
    Operations:
    - OperationName: AdminCommand
      OperationCommand: {setParameter: 1, internalEnableMultipleAutoGetCollections: true}
  - *Nop

# The 'SBE_INLJLookup' actor measures the SBE INLJ lookup performances and runs in the 8th phase.
- Name: SBE_INLJLookup
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..7
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *INLJTestOperations

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-all-feature-flags
